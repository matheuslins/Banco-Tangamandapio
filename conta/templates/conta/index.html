<!DOCTYPE html>
<html>
<head>
	<title>Banco de Tangamandápio</title>

	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en">
	<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
	<link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.amber-orange.min.css" />
	<script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

	<style type="text/css">
		html, body {
			font-family: 'Roboto', 'Helvetica', sans-serif;
		}

		.banco-card {
			margin: 10px;
			width: 280px;
		}

		.banco-card td {
			padding: 5px;
		}

		.banco-card th {
			padding: 5px;
		}

		.banco-card-wide1 {
			width: 380px;
		}

	</style>
</head>
<body>
<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
	<header class="mdl-layout__header">
	<div class="mdl-layout__header-row">
		<span class="mdl-layout-title">Banco de Tangamandápio</span>
	</div>
	</header>

	<main class="mdl-layout__content">
	<div class="page-content">

		<div class="mdl-textfield mdl-js-textfield" style="margin: 10px; width: 80%">
			<input class="mdl-textfield__input" type="text" id="requrl">
			<label class="mdl-textfield__label" for="requrl">Insira aqui a URL de requisição (Ex.: http://localhost:8000/)</label>
		</div>

		<div class="grid">
		<div class="banco-card-wide1 banco-card mdl-card mdl-shadow--2dp">
			<div class="mdl-card__title mdl-card--expand">
				<h2 class="mdl-card__title-text">Lista de Contas</h2>
			</div>
			<div class="mdl-card__supporting-text">
				<table>
				<thead>
				<tr>
				<th class="mdl-data-table__cell--non-numeric">Conta</th>
				<th class="mdl-data-table__cell--non-numeric">Nome</th>
				<th class="mdl-data-table__cell--non-numeric">Saldo</th>
				</tr>
				</thead>
				<tbody id="tabcontas">
				<tr>
					<td>-</td>
					<td>-</td>
					<td>-</td>
				</tr>
				</tbody>
				</table>
			</div>
			<div class="mdl-card__actions mdl-card--border">
				<a class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect" onclick="javascript:atualizaContas();">
					Atualizar lista
				</a>
			</div>
		</div>

				<div class="banco-card-wide1 banco-card mdl-card mdl-shadow--2dp">
			<div class="mdl-card__title mdl-card--expand">
				<h2 class="mdl-card__title-text">Cédulas no Caixa Eletrônico</h2>
			</div>
			<div class="mdl-card__supporting-text">
				<table>
				<thead>
				<tr>
				<th>P$ 1</th>
				<th>P$ 2</th>
				<th>P$ 5</th>
				<th>P$ 10</th>
				<th>P$ 20</th>
				<th>P$ 50</th>
				<th>P$ 100</th>
				</tr>
				</thead>
				<tbody>
				<tr>
					<td id="ced1">-</td>
					<td id="ced2">-</td>
					<td id="ced5">-</td>
					<td id="ced10">-</td>
					<td id="ced20">-</td>
					<td id="ced50">-</td>
					<td id="ced100">-</td>
				</tr>
				</tbody>
				</table>
			</div>
			<div class="mdl-card__actions mdl-card--border">
				<a class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect" onclick="javascript:atualizaEstoque();">
					Atualizar tabela
				</a>
			</div>
		</div>

				<div class="banco-card mdl-card mdl-shadow--2dp">
			<div class="mdl-card__title mdl-card--expand">
				<h2 class="mdl-card__title-text">Mudar cédulas</h2>
			</div>
			<div class="mdl-card__supporting-text">
			<div class="mdl-textfield mdl-js-textfield">
				<input type="text" id="id1" value="1" hidden="hidden">
				<input type="text" id="cedula1" value="1" hidden="hidden">
				<input class="mdl-textfield__input" type="text" id="quantidade1">
				<label class="mdl-textfield__label" for="caixa1">Cédulas de 1</label>
			</div>
			<div class="mdl-textfield mdl-js-textfield">
				<input type="text" id="id2" value="2" hidden="hidden">
				<input type="text" id="cedula2" value="2" hidden="hidden">
				<input class="mdl-textfield__input" type="text" id="quantidade2">
				<label class="mdl-textfield__label" for="caixa2">Cédulas de 2</label>
			</div>
			<div class="mdl-textfield mdl-js-textfield">
				<input type="text" id="id5" value="5" hidden="hidden">
				<input type="text" id="cedula5" value="5" hidden="hidden">
				<input class="mdl-textfield__input" type="text" id="quantidade5">
				<label class="mdl-textfield__label" for="caixa5">Cédulas de 5</label>
			</div>
			<div class="mdl-textfield mdl-js-textfield">
				<input  type="text" id="id10" value="10" hidden="hidden">
				<input type="text" id="cedula10" value="10" hidden="hidden">
				<input class="mdl-textfield__input" type="text" id="quantidade10">
				<label class="mdl-textfield__label" for="caixa10">Cédulas de 10</label>
			</div>
			<div class="mdl-textfield mdl-js-textfield">
				<input type="text" id="id20" value="20" hidden="hidden">
				<input type="text" id="cedula20" value="20" hidden="hidden">
				<input class="mdl-textfield__input" type="text" id="quantidade20">
				<label class="mdl-textfield__label" for="caixa20">Cédulas de 20</label>
			</div>
			<div class="mdl-textfield mdl-js-textfield">
				<input type="text" id="id50" value="50" hidden="hidden">
				<input type="text" id="cedula50" value="50" hidden="hidden">
				<input class="mdl-textfield__input" type="text" id="quantidade50">
				<label class="mdl-textfield__label" for="caixa50">Cédulas de 50</label>
			</div>
			<div class="mdl-textfield mdl-js-textfield">
				<input type="text" id="id100" value="100" hidden="hidden">
				<input type="text" id="cedula100" value="100" hidden="hidden">
				<input class="mdl-textfield__input" type="text" id="quantidade100">
				<label class="mdl-textfield__label" for="caixa100">Cédulas de 100</label>
			</div>
			</div>
			<div class="mdl-card__actions mdl-card--border">
				<a class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect" onclick="javascript:estoqueCaixa();">
					Alterar estoque
				</a>
			</div>
		</div>

		<div class="banco-card mdl-card mdl-shadow--2dp">
			<div class="mdl-card__title mdl-card--expand">
				<h2 class="mdl-card__title-text">Nova Conta</h2>
			</div>
			<div class="mdl-card__supporting-text">
			<div class="mdl-textfield mdl-js-textfield">
				<input class="mdl-textfield__input" type="text" id="novanome">
				<label class="mdl-textfield__label" for="mudanome">Nome da nova conta</label>
			</div>
			<div class="mdl-textfield mdl-js-textfield">
				<input class="mdl-textfield__input" type="text" id="novasaldo">
				<label class="mdl-textfield__label" for="mudasaldo">Saldo da nova conta</label>
			</div>
			</div>
			<div class="mdl-card__actions mdl-card--border">
				<a class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect" onclick="javascript:novaConta();">
					Criar conta
				</a>
			</div>
		</div>

		<div class="banco-card mdl-card mdl-shadow--2dp">
			<div class="mdl-card__title mdl-card--expand">
				<h2 class="mdl-card__title-text">Saldo de Conta</h2>
			</div>
			<div class="mdl-card__supporting-text">
			<div class="mdl-textfield mdl-js-textfield">
				<input class="mdl-textfield__input" type="text" id="saldoid">
				<label class="mdl-textfield__label" for="saldoid">ID da conta</label>
			</div>
			</div>
			<div class="mdl-card__actions mdl-card--border">
				<a class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect" onclick="javascript:saldoConta();">
					Ver saldo
				</a>
			</div>
		</div>

		<div class="banco-card mdl-card mdl-shadow--2dp">
			<div class="mdl-card__title mdl-card--expand">
				<h2 class="mdl-card__title-text">Mudar Conta</h2>
			</div>
			<div class="mdl-card__supporting-text">
			<div class="mdl-textfield mdl-js-textfield">
				<input class="mdl-textfield__input" type="text" id="mudaid">
				<label class="mdl-textfield__label" for="mudaid">ID da conta</label>
			</div>
			<div class="mdl-textfield mdl-js-textfield">
				<input class="mdl-textfield__input" type="text" id="mudanome">
				<label class="mdl-textfield__label" for="mudanome">Novo nome da conta</label>
			</div>
			<div class="mdl-textfield mdl-js-textfield">
				<input class="mdl-textfield__input" type="text" id="mudasaldo">
				<label class="mdl-textfield__label" for="mudasaldo">Novo saldo da conta</label>
			</div>
			</div>
			<div class="mdl-card__actions mdl-card--border">
				<a class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect" onclick="javascript:mudarConta();">
					Mudar conta
				</a>
			</div>
		</div>

		<div class="banco-card mdl-card mdl-shadow--2dp">
			<div class="mdl-card__title mdl-card--expand">
				<h2 class="mdl-card__title-text">Saque de Conta</h2>
			</div>
			<div class="mdl-card__supporting-text">
			<div class="mdl-textfield mdl-js-textfield">
				<input class="mdl-textfield__input" type="text" id="saqueid">
				<label class="mdl-textfield__label" for="saqueid">ID da conta</label>
			</div>
			<div class="mdl-textfield mdl-js-textfield">
				<input class="mdl-textfield__input" type="text" id="saquevalor">
				<label class="mdl-textfield__label" for="saquevalor">Valor do saque</label>
			</div>
			</div>
			<div class="mdl-card__actions mdl-card--border">
				<a class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect" onclick="javascript:saqueConta();">
					Realizar saque
				</a>
			</div>
		</div>

		</div>
	</div>
	</main>
</div>

<div id="toast-message" class="mdl-js-snackbar mdl-snackbar">
  <div class="mdl-snackbar__text"></div>
  <button class="mdl-snackbar__action" type="button"></button>
</div>

<dialog class="mdl-dialog">
<h4 class="mdl-dialog__title" id="dialogtitle">Título</h4>
<div class="mdl-dialog__content">
<p id="dialogcontent">Conteúdo</p>
</div>
<div class="mdl-dialog__actions">
<button type="button" class="mdl-button close">OK</button>
</div>
</dialog>

<script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
<script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script>
var dialog = document.querySelector('dialog');
if (! dialog.showModal) {
	dialogPolyfill.registerDialog(dialog);
}

dialog.querySelector('.close').addEventListener('click', function() {
	dialog.close();
});

var snackbarContainer = document.querySelector('#toast-message');

function atualizaContas() {
	$.get($("#requrl").val() + 'contas/', function (data) {
		var tabela = '';

		for (var i = 0; i < data.length; i++) {
			tabela += '<tr><td>'+data[i].id+'</td><td>'+data[i].nome+'</td><td>'+data[i].saldo+'</td></tr>';
		}

		$("#tabcontas").html(tabela);
		$grid.masonry();

		snackbarContainer.MaterialSnackbar.showSnackbar({message: "Lista de contas atualizada."});

	});
}

function atualizaEstoque() {
	$.get($("#requrl").val() + 'caixa/', function (data) {
		$("#ced1").text(data["0"]["quantidade"]);
		$("#ced2").text(data["1"]["quantidade"]);
		$("#ced5").text(data["2"]["quantidade"]);
		$("#ced10").text(data["3"]["quantidade"]);
		$("#ced20").text(data["4"]["quantidade"]);
		$("#ced50").text(data["5"]["quantidade"]);
		$("#ced100").text(data["6"]["quantidade"]);

		snackbarContainer.MaterialSnackbar.showSnackbar({message: "Estoque do caixa eletrônico atualizado."});

	});
}

function novaConta() {
	$.post($("#requrl").val() + 'contas/', {
		"nome": $("#novanome").val(),
		"saldo": $("#novasaldo").val(),
		'csrfmiddlewaretoken': '{{ csrf_token }}'
		},
		function (data) {
			mostraModal('Nova conta', 'Nova conta #' + data.id + ' de ' + data.nome + ' com R$ ' + data.saldo);
	});
}

function saldoConta() {
	$.get($("#requrl").val() + $("#saldoid").val() + '/contas/', function (data) {
		mostraModal('Saldo', 'Conta de ' + data.nome + ' com R$ ' + data.saldo);
	});
}

function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
        }
    }
});

function mudarConta() {
	$.ajax({
    type: 'PUT',
    url: $("#requrl").val() + $("#mudaid").val() + '/contas/',
    data: {
			"nome": $("#mudanome").val(),
			"saldo": $("#mudasaldo").val(),
		},
		success: function (data) {
			mostraModal('Conta modificada', 'Conta de ' + data.nome + ' com P$ ' + data.saldo);
		}
	});
}

function saqueConta() {
	$.post($("#requrl").val() + $("#saqueid").val() + '/conta' + '/saque/', {
		"conta": $("#saqueid").val(),
		"valor": $("#saquevalor").val(),
			}, function (data) {
				if(data['message']){
					snackbarContainer.MaterialSnackbar.showSnackbar({message: data['message']});
				}
				else{
					var CEDULAS = {1: "1", 2: "2", 3: "5", 4: "10", 5: "20", 6: "50", 7: "100"}
					var VALOR = data['caixa']
					for (var i = 1; i < 8; i++) {
						var num = i.toString()
						$.ajax({
					    type: 'PUT',
					    url: $("#requrl").val() + $("#id"+CEDULAS[num]).val() + '/caixa/',
					    data: {
								"cedula": $("#cedula"+CEDULAS[num]).val(),
								"quantidade": VALOR[parseInt(CEDULAS[i])],
							},
							success: function (data) {
								$("#ced"+CEDULAS[num]).text(VALOR[i]);
							}
						});
					}
					mostraModal('Saque realizado', '<ul><li>'+data['cedulas'][1]+' notas de P$ 1</li><li>'+data['cedulas'][2]+' notas de P$ 2</li><li>'+data['cedulas'][5]+' notas de P$ 5</li><li>'+data['cedulas'][10]+' notas de P$ 10</li><li>'+data['cedulas'][20]+' notas de P$ 20</li><li>'+data['cedulas'][50]+' notas de P$ 50</li><li>'+data['cedulas'][100]+' notas de P$ 100</li></ul>');
				}
	});
}

function estoqueCaixa() {
	var CEDULAS = {1: "1", 2: "2", 3: "5", 4: "10", 5: "20", 6: "50", 7: "100"}

	for (var i = 1; i < 8; i++) {
		var num = i.toString()
		$.ajax({
	    type: 'PUT',
	    url: $("#requrl").val() + $("#id"+CEDULAS[num]).val() + '/caixa/',
	    data: {
				"cedula": $("#cedula"+CEDULAS[num]).val(),
				"quantidade": $("#quantidade"+CEDULAS[num]).val(),
			},
			success: function (data) {
				$("#ced"+CEDULAS[num]).text(data[CEDULAS[num]]["quantidade"]);
			}
		});
	}
	snackbarContainer.MaterialSnackbar.showSnackbar({message: "Estoque do caixa eletrônico atualizado."});
}

function mostraModal(titulo, conteudo) {
	$("#dialogtitle").text(titulo);
	$("#dialogcontent").html(conteudo);
	dialog.showModal();
}

var $grid = $('.grid').masonry({
	itemSelector: '.banco-card',
	columnWidth: 100
});
</script>
</body>
</html>
